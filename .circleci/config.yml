version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@1.0.0

commands:
  debug:
    steps:
      - run:
          command: |
            cat /tmp/pipeline-parameters.json
  extract-config-list:
    parameters:
      pipeline-parameters-json-file:
        type: string
        default: /tmp/pipeline-parameters.json
      config-list-path:
        default: /tmp/filtered-config-list
        type: string
    steps:
      - run:
          name: Extract config list
          command: |
            INPUT_JSON_FILE=<<parameters.pipeline-parameters-json-file>>
            OUTPUT_FILE=<<parameters.config-list-path>>

            if [ ! -f "$INPUT_JSON_FILE" ]; then
              echo "Input JSON file does not exist: $INPUT_JSON_FILE"
              exit 1
            fi

            jq -r '.. | scalars' "$INPUT_JSON_FILE" > "$OUTPUT_FILE"

            echo "Values extracted from JSON file and saved to $OUTPUT_FILE"

            cat "$OUTPUT_FILE"
  merge-config-list:
    parameters:
      config-list-path:
        default: /tmp/filtered-config-list
        type: string
      continue-config:
        type: string
        default: .circleci/continue-config.yml
    steps:
      - run:
          name: Merge config list
          command: |

            xargs -a "<<parameters.config-list-path>>" yq -y -s 'reduce .[] as $item ({}; . * $item)' | tee "<< parameters.continue-config >>"

            cat << parameters.continue-config >>

# jobs:
#   filter:
#     docker:
#       - image: cimg/python:3.9
#     steps:
#       - checkout
#       - path-filtering/filter:
#           mapping: |
#             .* params test .circleci/pants_config.yml
#             src/web/.* params test .circleci/web_config.yml
      # - run:
      #     name: Install yq
      #     command: pip install yq
      # - path-filtering/set-parameters:
      #     base-revision: main
      #     mapping: |
      #       .* pants_config ".circleci/pants_config.yml"
      #       src/web/.* web_config ".circleci/web_config.yml"
      # - debug
      # - extract-config-list
      # - merge-config-list
      # - continuation/continue:
      #     configuration_path: .circleci/continue-config.yml

workflows:
  generate-configs:
    jobs:
      - path-filtering/filter:
          mapping: |
            .* message "test" .circleci/pants_config.yml
      - path-filtering/filter:
          mapping: |
            src/web/.* message "test" .circleci/web_config.yml